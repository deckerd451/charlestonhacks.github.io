<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dex AGI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; font-family:'Inter','Segoe UI',Arial,sans-serif; color:#eee; min-height:100vh; background:#101010; }
    #container { position:relative; z-index:1; max-width:1200px; margin:0 auto; padding:28px 16px 0; text-align:center; }
    #title { font-size:2.1em; font-weight:600; color:#0bb; }
    #desc  { font-size:1.1em; color:#aaa; margin-bottom:12px; }

    .card { max-width:520px; margin:0 auto 18px; padding:20px; background:#181818; border:1px solid #2a2a2a; border-radius:10px; box-shadow:0 2px 12px #000a; text-align:left; }
    .row { display:flex; gap:10px; }
    label { display:block; font-size:.92em; color:#bbb; margin:10px 0 6px; }
    input[type="text"], input[type="email"], input[type="number"], select { padding:10px; width:100%; border:1px solid #0bb5; border-radius:6px; background:#222; color:#eee; font-size:1em; }
    input:focus, select:focus { outline:none; border-color:#0bb; }
    button { padding:10px 18px; background:#0bb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    button:hover { background:#099; }

    #auth-status { margin-top:10px; font-size:.95em; }
    #auth-status.success { color:#0bb; } #auth-status.error { color:#ff7a7a; }

    .tab-nav { display:none; gap:10px; justify-content:center; border-bottom:2px solid #333; padding-bottom:6px; margin:12px auto 8px; max-width:980px; }
    .tab-button { background:#2a2a3a; color:#eee; border:0; padding:10px 14px; cursor:pointer; border-radius:6px 6px 0 0; font-size:.95em; }
    .tab-button.active { background:#ffd700; color:#222; font-weight:700; }
    .tab-pane { display:none; padding:6px 0 0; }
    .tab-pane.active { display:block; }

    #session-bar { display:none; max-width:1200px; margin:0 auto 8px; text-align:right; }
    #whoami { opacity:.7; margin-right:10px; }

    #neural-canvas { position:fixed; top:0; left:0; width:100vw; height:100vh; display:none; border:0; border-radius:0; margin:0; background:#181818; box-shadow:none; z-index:0; }
    #tooltip { position:absolute; background:#111; color:#0ff; padding:8px 14px; font-size:.95em; border-radius:8px; border:1px solid #0bb; pointer-events:none; opacity:.95; display:none; z-index:2; }
    .top-actions { display:none; gap:10px; justify-content:center; margin-bottom:10px; }
    .card-container { display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:10px; }
    .mini-card { background:#1d1d1d; border:1px solid #2a2a2a; border-radius:8px; padding:12px; }
    .mini-card h4 { margin:0 0 6px; color:#ffd700; font-size:1.05em; }
    .muted { opacity:.7; font-size:.9em; }
  </style>
</head>
<body>
  <div id="container">
    <div id="title">Dex AGI Neural Interactive</div>
    <div id="desc">Visualize and arrange your connections. Sign in, create your profile, and your node will appear in the network.</div>

    <div id="debug-session" style="margin:6px auto 10px;max-width:1200px;text-align:center;opacity:.85;font-size:.92em;">
      Session: <span id="debug-session-state">checking…</span>
    </div>

    <div id="auth-pane" class="card">
      <label for="email">Email</label>
      <input id="email" type="email" placeholder="Enter your email" autocomplete="email" />
      <button id="login-btn" style="margin-top:10px;">Sign In / Sign Up (Magic Link)</button>
      <div id="auth-status"></div>
    </div>

    <div id="profile-pane" class="card" style="display:none;">
      <h3 style="margin-top:0;">Create Your Profile</h3>
      <form id="profile-form" autocomplete="on">
        <div class="row">
          <div style="flex:1;">
            <label for="first-name">First Name</label>
            <input type="text" id="first-name" required autocomplete="given-name" />
          </div>
          <div style="flex:1;">
            <label for="last-name">Last Name</label>
            <input type="text" id="last-name" required autocomplete="family-name" />
          </div>
        </div>

        <label for="profile-email">Email</label>
        <input type="email" id="profile-email" required autocomplete="email" />

        <label for="skills-input">Professional Skills (comma separated)</label>
        <input type="text" id="skills-input" placeholder="e.g. aws, fullstack, java, python" required autocomplete="off" />

        <label for="bio-input">Short Bio <span style="opacity:.6">(Optional)</span></label>
        <input type="text" id="bio-input" placeholder="Tell us about yourself" maxlength="120" autocomplete="off" />

        <label for="availability-input">Current Availability</label>
        <select id="availability-input">
          <option value="Available">Available</option>
          <option value="Busy">Busy</option>
          <option value="Not Looking">Not Looking</option>
        </select>

        <label style="display:flex; align-items:flex-start; gap:10px; margin-top:10px;">
          <input type="checkbox" id="newsletter-optin" />
          <span>Subscribe me to the CharlestonHacks newsletter.<br><small class="muted">You can unsubscribe anytime via the email footer.</small></span>
        </label>

        <div style="display:flex; gap:10px; margin-top:12px;">
          <button type="submit">Save Profile</button>
          <button type="button" id="skip-to-network" style="background:#333;border:1px solid #555;">Skip for now</button>
        </div>
        <div id="profile-status" style="margin-top:10px;"></div>
      </form>
    </div>

    <div id="tab-nav" class="tab-nav" role="tablist" aria-label="Dex sections">
      <button class="tab-button active" data-tab="network" role="tab" aria-selected="true">Network</button>
      <button class="tab-button" data-tab="search" role="tab" aria-selected="false">Search</button>
      <button class="tab-button" data-tab="team" role="tab" aria-selected="false">Team Builder</button>
      <button class="tab-button" data-tab="leaderboard" role="tab" aria-selected="false">Leaderboard</button>
    </div>

    <div id="session-bar">
      <span id="whoami"></span>
      <button id="logout-btn">Sign Out</button>
    </div>

    <div id="top-actions" class="top-actions">
      <button id="toggle-layout">Use Grid</button>
    </div>

    <div id="pane-network" class="tab-pane active" role="tabpanel" aria-labelledby="network"></div>

    <div id="pane-search" class="tab-pane" role="tabpanel" aria-labelledby="search">
      <div class="card" style="max-width:980px;">
        <h3 style="margin-top:0;">Individual Search</h3>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:240px;">
            <label for="teamSkillsInput">Required Skills</label>
            <input type="text" id="teamSkillsInput" placeholder="e.g. aws, fullstack, java, python" autocomplete="off" />
          </div>
          <div><button id="find-team-btn" type="button">Get People</button></div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:240px;">
            <label for="nameInput">Search by First/Last Name</label>
            <input type="text" id="nameInput" placeholder="e.g. John, Doug, Will, Dave" autocomplete="name" />
          </div>
          <div><button id="search-name-btn" type="button">Find by Name</button></div>
        </div>
        <div id="matchNotification" style="display:none; margin-top:10px; color:#0bb;"></div>
        <div id="noResults" style="display:none; margin-top:10px; color:#ff7a7a;"></div>
        <div id="cardContainer" class="card-container" role="list" aria-label="Matching team members" style="margin-top:12px;"></div>
      </div>
    </div>

    <div id="pane-team" class="tab-pane" role="tabpanel" aria-labelledby="team">
      <div class="card" style="max-width:980px;">
        <h3 style="margin-top:0;">Team Builder</h3>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:240px;">
            <label for="team-skills-input">Required Skills</label>
            <input type="text" id="team-skills-input" placeholder="e.g. aws, fullstack, java, python" autocomplete="off" />
          </div>
          <div style="width:140px;">
            <label for="teamSize">Team Size</label>
            <input type="number" id="teamSize" placeholder="e.g. 3" min="1" max="6" autocomplete="off" />
          </div>
          <div><button id="build-team-btn" type="button">Build Team</button></div>
        </div>
        <div class="card-container" id="bestTeamContainer" role="list" aria-label="Best matched team" style="margin-top:12px;"></div>
      </div>
    </div>

    <div id="pane-leaderboard" class="tab-pane" role="tabpanel" aria-labelledby="leaderboard">
      <div class="card" style="max-width:980px;">
        <h3 style="margin-top:0;">Top Endorsed Skills</h3>
        <div id="leaderboard-rows"></div>
      </div>
    </div>
  </div>

  <canvas id="neural-canvas"></canvas>
  <div id="tooltip"></div>

<script type="module">
  import { supabaseClient as supabase } from './assets/js/supabaseClient.js';
  import { initDexAuth } from './assets/js/dexAuth.js';

  const DEX_URL = new URL('dex.html', window.location.href).href;
  const PROJECT_REF = 'hvmotpzhliufzomewzfl';

  const authPane     = document.getElementById('auth-pane');
  const profilePane  = document.getElementById('profile-pane');
  const profileForm  = document.getElementById('profile-form');
  const loginBtn     = document.getElementById('login-btn');
  const logoutBtn    = document.getElementById('logout-btn');
  const authStatusEl = document.getElementById('auth-status');
  const tabNav       = document.getElementById('tab-nav');
  const topActions   = document.getElementById('top-actions');
  const sessionBar   = document.getElementById('session-bar');
  const whoami       = document.getElementById('whoami');
  const debugStateEl = document.getElementById('debug-session-state');

  function setAuthStatus(msg, isError=false){ authStatusEl.textContent = msg || ''; authStatusEl.className = isError ? 'error' : 'success'; }
  function showDebug(state, extra=''){ if(!debugStateEl) return; debugStateEl.textContent = `${state}${extra ? ' — ' + extra : ''}`; console.log('[DEX DEBUG]', state, extra); }

  async function fetchMyProfile(userId){
    const { data, error } = await supabase.from('community').select('*').eq('user_id', userId).limit(1).maybeSingle();
    if (error && error.code !== 'PGRST116') console.error('fetchMyProfile error:', error);
    return data || null;
  }

  function showProfileForm(prefillEmail){ document.getElementById('profile-email').value = prefillEmail || ''; authPane.style.display='none'; profilePane.style.display='block'; }
  function hideProfileForm(){ profilePane.style.display='none'; }

  function setActiveTab(key){
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === key);
      btn.setAttribute('aria-selected', btn.dataset.tab === key ? 'true' : 'false');
    });
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.toggle('active', p.id === `pane-${key}`));
    document.dispatchEvent(new CustomEvent('dex:tab-changed', { detail: { tab:key } }));
  }
  document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

  // --- Auth ---
  loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  if (!email) return setAuthStatus('Enter email', true);
  loginBtn.disabled = true; setAuthStatus('Sending link…');
  const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: DEX_URL }});
  setAuthStatus(error ? error.message : 'Check your inbox for the magic link', !!error);
  setTimeout(() => (loginBtn.disabled = false), 60000);
});


  logoutBtn.addEventListener('click', async () => {
    try {
      await supabase.auth.signOut();
      localStorage.removeItem(`sb-${PROJECT_REF}-auth-token`);
      localStorage.removeItem('supabase.auth.token');
      sessionBar.style.display='none'; whoami.textContent='';
      authPane.style.display='block'; tabNav.style.display='none'; topActions.style.display='none';
      hideProfileForm(); setActiveTab('network'); setAuthStatus(''); window.location.reload();
    } catch (err) { console.error('Logout failed:', err); setAuthStatus('Logout failed. Try hard refresh (Cmd/Ctrl+Shift+R).', true); }
  });

  // Profile submit
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { data:{ session } } = await supabase.auth.getSession();
    const user = session?.user;
    const statusEl = document.getElementById('profile-status');
    const setProfileStatus = (msg, isError=false) => { statusEl.textContent = msg || ''; statusEl.style.color = isError ? '#ff7a7a' : '#0bb'; };
    if (!user) return setProfileStatus('Not authenticated. Please sign in again.', true);

    const fname = document.getElementById('first-name').value.trim();
    const lname = document.getElementById('last-name').value.trim();
    const email = document.getElementById('profile-email').value.trim();
    const skillsRaw = document.getElementById('skills-input').value.trim();
    const bio  = document.getElementById('bio-input').value.trim();
    const availability = document.getElementById('availability-input').value;
    const newsletterOptIn = document.getElementById('newsletter-optin').checked;

    const skills = skillsRaw ? skillsRaw.split(',').map(s => s.trim().toLowerCase()).filter(Boolean) : [];

    const row = {
      user_id:user.id, name:`${fname} ${lname}`.trim(), email,
      skills, interests:[], availability, endorsements:0, bio, x:0, y:0,
      newsletter_opt_in: !!newsletterOptIn,
      newsletter_opt_in_at: newsletterOptIn ? new Date().toISOString() : null
    };

    setProfileStatus('Saving…');
    const { error } = await supabase.from('community').insert(row);
    if (error) return setProfileStatus(error.message || 'Could not save profile', true);

    if (newsletterOptIn) {
      try {
        const mcForm = document.createElement('form');
        mcForm.action = 'https://charlestonhacks.us12.list-manage.com/subscribe/post?u=79363b7a43970f760d61360fd&id=3b95e0177a';
        mcForm.method = 'POST'; mcForm.target = '_blank';
        mcForm.innerHTML = `<input type="hidden" name="FNAME" value="${fname}"><input type="hidden" name="LNAME" value="${lname}"><input type="hidden" name="EMAIL" value="${email}">`;
        document.body.appendChild(mcForm); mcForm.submit(); document.body.removeChild(mcForm);
      } catch (e2) { console.warn('Mailchimp subscribe failed (non-blocking):', e2); }
    }

    setProfileStatus('Saved! Loading your network…');
    hideProfileForm(); setActiveTab('network'); setTimeout(() => window.location.reload(), 600);
  });

  supabase.auth.onAuthStateChange(async (_event, session) => {
    if (session?.user) {
      showDebug('logged in', session.user.email || session.user.id);
      whoami.textContent = session.user.email || '';
      sessionBar.style.display='block'; tabNav.style.display='flex'; topActions.style.display='flex';
      const existing = await fetchMyProfile(session.user.id);
      if (!existing) showProfileForm(session.user.email || ''); else hideProfileForm();
      setActiveTab('network');
    } else {
      showDebug('logged out');
      whoami.textContent=''; sessionBar.style.display='none'; tabNav.style.display='none'; topActions.style.display='none';
      hideProfileForm(); setActiveTab('network');
    }
  });

  (async () => {
    const session = await initDexAuth();
    showDebug(session?.user ? 'Session present' : 'No session');
    if (session?.user) {
      history.replaceState({}, '', new URL('dex.html', window.location.href).href);
      whoami.textContent = session.user.email || '';
      sessionBar.style.display='block'; tabNav.style.display='flex'; topActions.style.display='flex';
      const existing = await fetchMyProfile(session.user.id);
      if (!existing) showProfileForm(session.user.email || ''); else hideProfileForm();
      setActiveTab('network');
    } else {
      authPane.style.display='block';
    }
  })();

  // ---------- SEARCH ----------
  async function requireSessionOrWarn() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { alert('Please sign in first to search.'); return false; }
    return true;
  }

  function renderPeople(list){
    const cards = document.getElementById('cardContainer');
    const matchNote = document.getElementById('matchNotification');
    const noResults = document.getElementById('noResults');
    if (!cards || !matchNote || !noResults){ console.error('[SEARCH] Missing containers'); return; }
    cards.innerHTML = '';
    if (!list || !list.length){
      noResults.style.display='block'; noResults.textContent='No results.'; matchNote.style.display='none'; return;
    }
    noResults.style.display='none'; matchNote.style.display='block';
    matchNote.textContent = `Found ${list.length} result${list.length>1?'s':''}.`;
    list.forEach(p=>{
      const el=document.createElement('div'); el.className='mini-card';
      el.innerHTML = `<h4>${p.name ?? '(no name)'}</h4>
        <div class="muted">${Array.isArray(p.skills)?p.skills.join(', '):(p.skills||'No skills listed')}</div>
        <div class="muted">${p.availability || p.Availability || ''}</div>
        <div class="muted">${p.bio || p.Bio || ''}</div>`;
      cards.appendChild(el);
    });
  }

  // text[] contains; then PostgREST cs.{...} fallback
  async function queryBySkills(terms){
    console.log('[SEARCH] queryBySkills terms:', terms);
    try{
      const { data, error } = await supabase.from('community').select('*').contains('skills', terms);
      if (error) throw error;
      if (Array.isArray(data) && data.length) return data;
    }catch(e){ console.warn('[SEARCH] .contains failed:', e?.message || e); }
    try{
      const csParam = `{${terms.join(',')}}`; // {aws,python}
      const { data, error } = await supabase.from('community').select('*').filter('skills','cs', csParam);
      if (error) throw error;
      if (Array.isArray(data) && data.length) return data;
    }catch(e){ console.error('[SEARCH] cs fallback failed:', e?.message || e); }
    return [];
  }

  // ONLY query the "name" column (your table has no first_name/last_name)
  async function queryByName(q){
    console.log('[SEARCH] queryByName q:', q);
    const { data, error } = await supabase.from('community').select('*').ilike('name', `%${q}%`);
    if (error){ console.error('[SEARCH] name search failed:', error); return []; }
    return data || [];
  }

 function wireSearchHandlers(){
  const findBtn = document.getElementById('find-team-btn');
  const nameBtn = document.getElementById('search-name-btn');
  if(!findBtn || !nameBtn){ console.error('[SEARCH] Buttons not found'); return; }
  console.log('[SEARCH] Handlers wired.');

  findBtn.addEventListener('click', async ()=>{
    if (!(await requireSessionOrWarn())) return;
    console.log('[SEARCH] find-team-btn clicked');
    const raw = document.getElementById('teamSkillsInput')?.value?.trim() || '';
    if (!raw){ renderPeople([]); return; }
    const terms = raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    document.getElementById('matchNotification').style.display='none';
    document.getElementById('noResults').style.display='none';
    try{
      const rows = await queryBySkills(terms);
      console.log('[SEARCH] skills results:', rows?.length);
      renderPeople(rows);
    }catch(err){ console.error('[SEARCH] skills handler error:', err); renderPeople([]); }
  });

  nameBtn.addEventListener('click', async ()=>{
    if (!(await requireSessionOrWarn())) return;
    console.log('[SEARCH] search-name-btn clicked');
    const q = (document.getElementById('nameInput')?.value || '').trim();
    if (!q){ renderPeople([]); return; }
    document.getElementById('matchNotification').style.display='none';
    document.getElementById('noResults').style.display='none';
    try{
      const rows = await queryByName(q);
      console.log('[SEARCH] name results:', rows?.length);
      renderPeople(rows);
    }catch(err){ console.error('[SEARCH] name handler error:', err); renderPeople([]); }
  });
}

// Run now if DOM is ready; otherwise wait.
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', wireSearchHandlers);
} else {
  wireSearchHandlers();
}

  // For quick manual testing
  window.__dexRenderPeople = renderPeople;
 
</script>

<script type="module" src="./assets/js/neuralInteractive.js"></script>
</body>
</html>


